---
title: "group_project_1_ricco_ferraro"
author: "Ricco Ferraro"
date: "1/30/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
  
Libraries
```{r}
library(leaps)
library(magrittr) # makes the pipe %>% work
library(ggplot2)
library(tidyverse)
library(reshape2)
library(car)     # where vif function lives
library(ISLR)
library(leaps)
library(dplyr)
library(doBy)
library(e1071)
library(class)
library(caret)
library(Metrics)
library(gtools)
library(glmnet)
library(kableExtra)
library(coefplot)
library(data.table)
```

Data I/O
```{r}
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
CaseData = read.csv('data1.csv',header = T,sep = ",", stringsAsFactors = TRUE)
```


Summary Stats Original Data
```{r}
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
CaseData = data.frame(CaseData, stringsAsFactors = TRUE)

CaseData %>% ggplot(aes(x=Year, y=MSRP, fill = Vehicle.Style)) + geom_boxplot() + theme_dark() 
facet_wrap(~Driven_Wheels) 

CaseData %>% ggplot(aes(x=Engine.Cylinders, y=MSRP,color=Year))+ geom_point() + facet_wrap(~Driven_Wheels) + theme_dark()


CaseData %>% ggplot(aes(x=Engine.Cylinders, y=MSRP,color=Year))+ geom_point()+ theme_dark()

#remove_missing(CaseData)

classifyDATA <- CaseData[,c(3,5,6,9,13,14,15)]
classifyDATA$Response <- CaseData[,c(16)]

glimpse(classifyDATA)

#M <- cor(CaseData)
#corrplot(M, col=brewer.pal(n=6, name="RdYlBu"),tl.cex = .75)

sapply(CaseData, function(x) length(unique(x)))

count_pct <- function(df) {
  return(
    df %>%
      tally %>% 
      mutate(n_pct = 100*n/sum(n))
  )
}

CaseData %>% 
  group_by(Transmission.Type) %>% 
  count_pct


CaseData %>% 
  group_by(Driven_Wheels) %>% 
  count_pct

CaseData %>% 
  group_by(Number.of.Doors) %>% 
  count_pct


CaseData %>% 
  group_by(Vehicle.Size) %>% 
  count_pct

CaseData %>% 
  group_by(Engine.Fuel.Type) %>% 
  count_pct


CaseData %>% 
  group_by(Vehicle.Style) %>% 
  count_pct


colnames(is.na(CaseData))

#CHANGE TO THE IS 0 , NA 
which (is.na(CaseData))

CaseData %>%
  summarise_all(funs(sum(is.na(.))))

skewness(CaseData$MSRP)
skewness(CaseData$Popularity)

CaseData$Popularity2 <- as.factor(CaseData$Popularity)

CaseData %>% ggplot(mapping = aes(x=Popularity)) + geom_histogram(binwidth =250 )

#CaseData %>% ggplot(mapping = aes(x=Popularity2, fill = Market.Category)) + geom_histogram(binwidth =250 )

glimpse(CaseData)

CaseData %>% ggplot(mapping = aes(x=MSRP)) + geom_histogram(binwidth =250 )

model.fit<-aov(MSRP~Popularity2,data=CaseData)
#par(mfrow=c(2,2))
#plot(model.fit$fitted.values,model.fit$residuals,ylab="Resdiduals",xlab="Fitted")
#qqnorm(model.fit$residuals)

par(mfrow=c(2,2))
plot(model.fit)


model2.fit<-lm(MSRP~Popularity2,data=CaseData)
#par(mfrow=c(2,2))
#plot(model.fit$fitted.values,model.fit$residuals,ylab="Resdiduals",xlab="Fitted")
#qqnorm(model.fit$residuals)

par(mfrow=c(2,2))
plot(model2.fit)


mysummary<-function(x){
  result<-c(length(x),mean(x),sd(x),sd(x)/length(x),min(x), max(x), IQR(x))
  names(result)<-c("N","Mean","SD","SE","MIN", "MAX","IQR")
  return(result)
}

#sumstats<-aggregate(MSRP~Cylinders,data=CaseData,mysummary)
#sumstats<-cbind(sumstats[,1:2],sumstats[,-(1:2)])

# ggplot(sumstats,aes(x=DepthCat,y=Mean,group=Strata,colour=Strata))+
#  ylab("Plot")+
# geom_line()+
# geom_point()+
# geom_errorbar(aes(ymin=Mean-SE,ymax=Mean+SE),width=.1)
```

Filter and Impute the Data
```{r}
isEmpty <- function(column) {
    is.na(column) | column == 0 | column == "" | column == " " | column == "NA" | column == "na" | column == "Na" | column == "nA" | column == "NaN" 
}

bucketFuelType <- function(fuelType) {
  regexPremium = "premium"
  regexNonPremium= "diesel|electric|unleaded"
  if_else(str_detect(fuelType, regexPremium), "premium", 
          if_else(str_detect(fuelType, regexNonPremium), str_extract(fuelType, regexNonPremium),
                  "other")
  )
}

#Filter out old cars
CaseData
CaseData %>% filter(MSRP > 2000) -> CaseData.NewCars.1
CaseData.NewCars = data.frame(CaseData.NewCars.1, stringsAsFactors = TRUE)

# filter Fuel.Type
CaseData.NewCars %>% filter(!isEmpty(Engine.Fuel.Type) & Engine.Fuel.Type != "natural gas") -> CaseData.NewCars.Filtered
CaseData.NewCars.Filtered

# summary known Engine.Hp's
Vehicle.Size.Summary <- CaseData.NewCars.Filtered %>% filter(!isEmpty(Engine.HP)) %>% group_by(Vehicle.Size) %>% summarise(median_hp_by_vehicle_size=median(Engine.HP)) 

# look at our summary
Vehicle.Size.Summary

#Impute values for Engine.HP by Vehicle.Size (for median Engine.HP)

CaseData.NewCars.Filtered.ImputedHP <-merge(CaseData.NewCars.Filtered, Vehicle.Size.Summary, by="Vehicle.Size")  %>% mutate(Engine.HP.Clean = if_else(isEmpty(Engine.HP), median_hp_by_vehicle_size, as.double(Engine.HP)))
CaseData.NewCars.Filtered.ImputedHP

# summary known Engine.Cylinders
Vehicle.Size.Summary <- CaseData.NewCars.Filtered.ImputedHP %>% filter(!isEmpty(Engine.Cylinders)) %>% group_by(Vehicle.Size) %>% summarise(median_cylinder_by_vehicle_size=median(Engine.Cylinders)) 

# look at our summary
Vehicle.Size.Summary

#Impute values for Engine.HP by Vehicle.Size (for median Engine.HP)
CaseData.NewCars.Filtered.ImputedHP$Engine.Cylinders <- as.double(CaseData.NewCars.Filtered.ImputedHP$Engine.Cylinders)
CaseData.NewCars.Filtered.ImputedHPAndCylinders <-merge(CaseData.NewCars.Filtered.ImputedHP, Vehicle.Size.Summary, by="Vehicle.Size")  %>% mutate(Engine.Cylinders.Clean = if_else(isEmpty(Engine.Cylinders), as.double(median_cylinder_by_vehicle_size), Engine.Cylinders))

#Doors (This mutates CaseData.NewCars.Filtered.ImputedHPAndCylinders)
CaseData.NewCars.Filtered.ImputedHPAndCylinders <- CaseData.NewCars.Filtered.ImputedHPAndCylinders %>% mutate(NumDoors.Clean=if_else((Make == 'Tesla' | Make == 'Ferrari') & isEmpty(Number.of.Doors), 4, as.numeric(Number.of.Doors))) 

CaseData.NewCars.Filtered.ImputedHPAndCylinders$Engine.Cylinders.Clean <- as.factor(CaseData.NewCars.Filtered.ImputedHPAndCylinders$Engine.Cylinders.Clean)
CaseData.NewCars.Filtered.ImputedHPAndCylinders$NumDoors.Clean <- as.factor(CaseData.NewCars.Filtered.ImputedHPAndCylinders$NumDoors.Clean)

#Bucket Engine.Fuel.Type NOTE we aren't currently using this. 
CaseData.NewCars.Filtered.ImputedHPAndCylindersAndFuelType <- CaseData.NewCars.Filtered.ImputedHPAndCylinders %>% filter(Engine.Fuel.Type != "electric" & highway.MPG < 100) %>%  mutate(Engine.Fuel.Type.Buckets=as.factor(bucketFuelType(Engine.Fuel.Type)))

summary(CaseData.NewCars.Filtered.ImputedHPAndCylindersAndFuelType)
myData <- CaseData.NewCars.Filtered.ImputedHPAndCylindersAndFuelType[, c('Vehicle.Size','Year', 'Engine.Fuel.Type', 'Transmission.Type', 'Driven_Wheels', 'Vehicle.Style', 'highway.MPG', 'city.mpg', 'Popularity', 'Engine.HP.Clean', 'Engine.Cylinders.Clean', 'NumDoors.Clean', 'MSRP')]
myData <- myData %>% filter(Year > 2000 & MSRP < 100000)
summary(myData)
```

## Summary of Data Before and After Impuding (Data Prep Continued)
```{r}
CaseData.NewCars.Filtered.ImputedHPAndCylinders -> A

# This can be placed in the main document
# Summary of Data Before and After Imputing
ktable <- data.frame(
  Horsepower = matrix(summary(A$Engine.HP)),
  HorsepowerClean = c(matrix(summary(as.double(A$Engine.HP.Clean))),"-"),
  Cylinders = matrix(summary(A$Engine.Cylinders)),
  CylindersClean = c(matrix(summary(as.numeric(A$Engine.Cylinders.Clean))),"-"),
  Doors =	matrix(summary(A$Number.of.Doors)),
  DoorsClean = c(matrix(summary(as.numeric(A$NumDoors.Clean))),"-")
)%>%
 kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover"), font_size = 12)%>%
    add_header_above(c("Summary Data Continued" = 6))
ktable

# data.frame(summary(CaseData.NewCars))
# data.frame(matrix(summary(CaseData.NewCars)))

```


``` {r}
myModelHP = lm(log(MSRP) ~ .-Engine.HP -Engine.Cylinders -Make -Number.of.Doors -Model -Engine.Fuel.Type -Market.Category -Popularity2 -median_cylinder_by_vehicle_size -median_hp_by_vehicle_size, data = myData)
predicted <- predict.lm(myModelHP)
summary(myModelHP)

vif(myModelHP)
```

``` {r}

count_pct <- function(df) {
  return(
    df %>%
      tally %>% 
      mutate(n_pct = 100*n/sum(n))
  )
}

myData %>% 
  group_by(Engine.Cylinders.Clean) %>% 
  count_pct


myData %>% 
  group_by(Transmission.Type) %>% 
  count_pct


myData %>% 
  group_by(Driven_Wheels) %>% 
  count_pct

myData %>% 
  group_by(Number.of.Doors) %>% 
  count_pct


myData %>% 
  group_by(Vehicle.Size) %>% 
  count_pct

myData %>% 
  group_by(Engine.Fuel.Type) %>% 
  count_pct


myData %>% 
  group_by(Vehicle.Style) %>% 
  count_pct



```


```{r}

myModel2 = lm(log(MSRP) ~ .-Engine.HP -Engine.Cylinders -Make -Vehicle.Style -Number.of.Doors -Model -Market.Category -Popularity2 -median_cylinder_by_vehicle_size -median_hp_by_vehicle_size, data = myData)
predicted <- predict.lm(myModel2)
summary(myModel2)

varImp(myModel2)

vif(myModel2)

```



```{r}

myModel3 = lm(MSRP ~ Engine.HP.Clean + Year, data = myData)
predicted <- predict.lm(myModel3)
summary(myModel3)

vif(myModel3)

```

Lasso Complex
``` {r}
matrixFormula <- function(data)
{
  # use fully saturated model with squared terms
  model.matrix(log(MSRP)~(.)^2, data)[, -1]
}
set.seed(1234)
splitPerc = .70
trainIndices = sample(1:dim(myData)[1],round(splitPerc * dim(myData)[1]))
train = myData[trainIndices,]
test = myData[-trainIndices,]

#Formatting data for GLM net
x_train= matrixFormula(train)
y_train=log(train$MSRP)
x_test<-matrixFormula(test)
y_test<-log(test$MSRP)
# Setting alpha = 1 implements lasso regression
?seq
grid=10^seq(from=-3.0,to=0.5,by=0.1)
lasso_reg <- cv.glmnet(x_train, y_train, alpha=1, lambda =grid, scale=TRUE, center=TRUE)
plot(lasso_reg)
coefplot(lasso_reg)


#for loop here to iterate all ase's vs lambda's
getTestAse <- function(lambda) {
  print(lambda)
  pred <- predict(lasso_reg, s=lambda, newx=x_test)
  print(mean(y_test-pred)^2)
  mean((y_test-pred)^2)
}

# Gather our Test ASE's from the lasso fit for different Constraint values (Lambda's)
TestAse <- data.frame(lambda = seq(from=.75*lasso_reg$lambda.min,to=1.25*lasso_reg$lambda.1se,by=0.00001))

# rowwise is needed here to make the getTestASE function run for every value of lambda....
TestAse <- TestAse %>% rowwise %>% mutate(Test_ASE=getTestAse(lambda))

# plot 
TestAse %>% ggplot(aes(x=log(lambda), y=Test_ASE)) + geom_point() + geom_vline(xintercept =log(lasso_reg$lambda.min), linetype="dashed", 
                color = "blue", size=0.5) + geom_text(aes(x=log(lasso_reg$lambda.min), label="\nLambda Min"), colour="blue",y=getTestAse(lasso_reg$lambda.min), text=element_text(size=11)) + geom_vline(xintercept =log(lasso_reg$lambda.1se), linetype="dashed", 
                color = "red", size=0.5) + geom_text(aes(x=log(lasso_reg$lambda.1se), label="\nLambda 1 SE"), colour="red",y=getTestAse(lasso_reg$lambda.min), text=element_text(size=11)) + ggtitle("Test ASE vs log Lambda")

lasso.pred.lambda.min=predict(lasso_reg,s=lasso_reg$lambda.min, newx=x_test)
lasso.pred.lambda.1se=predict(lasso_reg ,s=lasso_reg$lambda.1se, newx=x_test)

testMSE_LASSO.min<-mean((y_test-lasso.pred.lambda.min)^2)
testMSE_LASSO.min

testMSE_LASSO.1se<-mean((y_test-lasso.pred.lambda.1se)^2)
testMSE_LASSO.1se

chosenLassoModel <-lasso.pred.lambda.min

## We use Lambda MIN! 
```

```{r}
# makes a dense matrix
df_coeff.lambda.min <- as.data.frame(as.matrix(coef(lasso_reg, s = "lambda.min"))) 

# This captures row names from the matrix dataframe
setDT(df_coeff.lambda.min, keep.rownames = TRUE)[] 

#Capture variables in readable names
df_coeff.filtered.lambda.min <- df_coeff %>% mutate(variable=rn)
df_coeff.filtered.lambda.min$estimate = df_coeff$`1`

#Filter for significant estimates
df_coeff.filtered.lambda.min <- df_coeff.filtered.lambda.min %>% filter(estimate > 0.0000)
df_coeff.filtered.lambda.min #there should be 36 variables in the model at this point. 
```

Backward-Selection for validation of Lasso
```{r}
# Forward Selection 
reg.bkwd=regsubsets(log(MSRP)~(.)^2,data=train,method="backward",nvmax=50)


```


ASE plots
```{r}
bics<-summary(reg.bkwd)$bic
plot(1:50,bics,type="l",ylab="BIC",xlab="# of predictors")
index<-which(bics==min(bics))
points(index,bics[index],col="red",pch=10)
print("Min Bics is:")
which(bics==min(bics))
 
# Adjr2
adjr2<-summary(reg.bkwd)$adjr2
plot(1:20,adjr2,type="l",ylab="Adjusted R-squared",xlab="# of predictors")
index<-which(adjr2==max(adjr2))
points(index,adjr2[index],col="red",pch=10)
print("Max Adj R2 is:")
which(adjr2==max(adjr2))
 
MallowCP <- summary(reg.bkwd)$cp
plot(1:20,MallowCP,type="l",ylab="Mallow's CP",xlab="# of predictors")
index<-which(MallowCP==min(MallowCP))
points(index,MallowCP[index],col="red",pch=10)
print("Min Mallow CP is:")
which(MallowCP==min(MallowCP))

```

more EDA
```{r}
myData %>% ggplot(aes(x=Year, y=log(MSRP))) + geom_point()
myData %>% ggplot(aes(x=Year, y=log(MSRP))) + geom_smooth()

myData %>% ggplot(aes(x=highway.MPG, y=log(MSRP), colour=Engine.Fuel.Type)) + geom_point()
myData %>% ggplot(aes(x=highway.MPG, y=log(MSRP))) + geom_smooth()

myData %>% ggplot(aes(x=city.mpg, y=log(MSRP), colour=Engine.Fuel.Type)) + geom_point()
myData %>% ggplot(aes(x=city.mpg, y=log(MSRP))) + geom_smooth()

myData %>% ggplot(aes(x=Popularity, y=log(MSRP), colour=Engine.Fuel.Type)) +  geom_point() +
  geom_smooth(method = "nls", formula = y ~ a * x + b, se = F,
              method.args = list(start = list(a = 0.1, b = 0.1)))

myData %>% ggplot(aes(x=Engine.HP.Clean, y=log(MSRP), colour=Vehicle.Size)) + geom_point()
myData %>% ggplot(aes(x=Engine.HP.Clean, y=log(MSRP))) + geom_smooth()


tempModel <- lm(log(MSRP)~(.)^2, data=myData)
plot(tempModel)
coefplot(tempModel)
summary(tempModel)

```
