---
title: "group_project_1_ricco_ferraro"
author: "Ricco Ferraro"
date: "1/30/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
  
Libraries
```{r}
library(leaps)
library(magrittr) # makes the pipe %>% work
library(ggplot2)
library(tidyverse)
library(reshape2)
library(car)     # where vif function lives
library(ISLR)
library(leaps)
library(dplyr)
library(doBy)
library(e1071)
library(class)
library(caret)
library(Metrics)
library(gtools)
library(glmnet)
library(kableExtra)
```

Data I/O
```{r}
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
CaseData = read.csv('data1.csv',header = T,sep = ",", stringsAsFactors = TRUE)
```


Summary Stats Original Data
```{r}
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
CaseData = data.frame(CaseData, stringsAsFactors = TRUE)

CaseData <- filter(CaseData, MSRP < 100000)

CaseData %>% ggplot(aes(x=Year, y=MSRP, fill = Vehicle.Style)) + geom_boxplot() + theme_dark() 


facet_wrap(~Driven_Wheels) 

CaseData %>% ggplot(aes(x=Engine.Cylinders, y=MSRP,color=Year))+ geom_point() + facet_wrap(~Driven_Wheels) + theme_dark()


CaseData %>% ggplot(aes(x=Engine.Cylinders, y=MSRP,color=Year))+ geom_point()+ theme_dark()

remove_missing(CaseData)

classifyDATA <- CaseData[,c(3,5,6,9,13,14,15)]
classifyDATA$Response <- CaseData[,c(16)]

glimpse(classifyDATA)

#M <- cor(CaseData)
#corrplot(M, col=brewer.pal(n=6, name="RdYlBu"),tl.cex = .75)

sapply(CaseData, function(x) length(unique(x)))

count_pct <- function(df) {
  return(
    df %>%
      tally %>% 
      mutate(n_pct = 100*n/sum(n))
  )
}

CaseData %>% 
  group_by(Transmission.Type) %>% 
  count_pct


CaseData %>% 
  group_by(Driven_Wheels) %>% 
  count_pct

CaseData %>% 
  group_by(Number.of.Doors) %>% 
  count_pct


CaseData %>% 
  group_by(Vehicle.Size) %>% 
  count_pct

CaseData %>% 
  group_by(Engine.Fuel.Type) %>% 
  count_pct


CaseData %>% 
  group_by(Vehicle.Style) %>% 
  count_pct


colnames(is.na(CaseData))

#CHANGE TO THE IS 0 , NA 
which (is.na(CaseData))

CaseData %>%
  summarise_all(funs(sum(is.na(.))))

skewness(CaseData$MSRP)
skewness(CaseData$Popularity)

CaseData$Popularity2 <- as.factor(CaseData$Popularity)

CaseData %>% ggplot(mapping = aes(x=Popularity)) + geom_histogram(binwidth =250 )

#CaseData %>% ggplot(mapping = aes(x=Popularity2, fill = Market.Category)) + geom_histogram(binwidth =250 )

glimpse(CaseData)

CaseData %>% ggplot(mapping = aes(x=MSRP)) + geom_histogram(binwidth =250 )

model.fit<-aov(MSRP~Popularity2,data=CaseData)
#par(mfrow=c(2,2))
#plot(model.fit$fitted.values,model.fit$residuals,ylab="Resdiduals",xlab="Fitted")
#qqnorm(model.fit$residuals)

par(mfrow=c(2,2))
plot(model.fit)


model2.fit<-lm(MSRP~Popularity2,data=CaseData)
#par(mfrow=c(2,2))
#plot(model.fit$fitted.values,model.fit$residuals,ylab="Resdiduals",xlab="Fitted")
#qqnorm(model.fit$residuals)

par(mfrow=c(2,2))
plot(model2.fit)


mysummary<-function(x){
  result<-c(length(x),mean(x),sd(x),sd(x)/length(x),min(x), max(x), IQR(x))
  names(result)<-c("N","Mean","SD","SE","MIN", "MAX","IQR")
  return(result)
}

#sumstats<-aggregate(MSRP~Cylinders,data=CaseData,mysummary)
#sumstats<-cbind(sumstats[,1:2],sumstats[,-(1:2)])

# ggplot(sumstats,aes(x=DepthCat,y=Mean,group=Strata,colour=Strata))+
#  ylab("Plot")+
# geom_line()+
# geom_point()+
# geom_errorbar(aes(ymin=Mean-SE,ymax=Mean+SE),width=.1)
```

Filter and Impute the Data
```{r}
isEmpty <- function(column) {
    is.na(column) | column == 0 | column == "" | column == " " | column == "NA" | column == "na" | column == "Na" | column == "nA" | column == "NaN" 
}

#Filter out old cars
CaseData
CaseData %>% filter(MSRP > 2000) -> CaseData.NewCars.1
CaseData.NewCars = data.frame(CaseData.NewCars.1, stringsAsFactors = TRUE)

# filter Fuel.Type
CaseData.NewCars %>% filter(!isEmpty(Engine.Fuel.Type) & Engine.Fuel.Type != "natural gas") -> CaseData.NewCars.Filtered
CaseData.NewCars.Filtered

# summary known Engine.Hp's
Vehicle.Size.Summary <- CaseData.NewCars.Filtered %>% filter(!isEmpty(Engine.HP)) %>% group_by(Vehicle.Size) %>% summarise(median_hp_by_vehicle_size=median(Engine.HP)) 

# look at our summary
Vehicle.Size.Summary

#Impute values for Engine.HP by Vehicle.Size (for median Engine.HP)
CaseData.NewCars.Filtered.ImputedHP <-merge(CaseData.NewCars.Filtered, Vehicle.Size.Summary, by="Vehicle.Size")  %>% mutate(Engine.HP.Clean = if_else(isEmpty(Engine.HP), median_hp_by_vehicle_size, as.double(Engine.HP)))
CaseData.NewCars.Filtered.ImputedHP

# summary known Engine.Cylinders
Vehicle.Size.Summary <- CaseData.NewCars.Filtered.ImputedHP %>% filter(!isEmpty(Engine.Cylinders)) %>% group_by(Vehicle.Size) %>% summarise(median_cylinder_by_vehicle_size=median(Engine.Cylinders)) 

# look at our summary
Vehicle.Size.Summary

#Impute values for Engine.HP by Vehicle.Size (for median Engine.HP)
CaseData.NewCars.Filtered.ImputedHPAndCylinders <-merge(CaseData.NewCars.Filtered.ImputedHP, Vehicle.Size.Summary, by="Vehicle.Size")  %>% mutate(Engine.Cylinders.Clean = if_else(isEmpty(Engine.Cylinders), median_cylinder_by_vehicle_size, as.double(Engine.Cylinders)))


CaseData.NewCars.Filtered.ImputedHPAndCylinders %>% filter(isEmpty(Engine.Cylinders.Clean) | isEmpty(Engine.HP.Clean))
CaseData.NewCars.Filtered.ImputedHPAndCylinders
Vehicle.Size.Summary


#Doors (This mutates CaseData.NewCars.Filtered.ImputedHPAndCylinders)
CaseData.NewCars.Filtered.ImputedHPAndCylinders$NumDoors.Clean <- if_else(CaseData.NewCars.Filtered.ImputedHPAndCylinders$Make == 'Tesla' & isEmpty(CaseData.NewCars.Filtered.ImputedHPAndCylinders$Number.of.Doors), 4,as.numeric(CaseData.NewCars.Filtered.ImputedHPAndCylinders$Number.of.Doors))
CaseData.NewCars.Filtered.ImputedHPAndCylinders$NumDoors.Clean <- if_else(CaseData.NewCars.Filtered.ImputedHPAndCylinders$Make == 'Ferrari' & isEmpty(CaseData.NewCars.Filtered.ImputedHPAndCylinders$NumDoors.Clean), 2,as.numeric(CaseData.NewCars.Filtered.ImputedHPAndCylinders$Number.of.Doors))

CaseData.NewCars.Filtered.ImputedHPAndCylinders
glimpse(CaseData.NewCars.Filtered.ImputedHPAndCylinders)
```

## Summary of Data Before and After Impuding (Data Prep Continued)
```{r}
# This can be placed in the main document
# Summary of Data Before and After Imputing
ktable <- data.frame(
  Horsepower = matrix(summary(CaseData.NewCars[5])),
  HorsepowerClean = c(matrix(summary(CaseData.NewCars.Filtered.ImputedHPAndCylinders[18])),"-"),
  Cylinders = matrix(summary(CaseData.NewCars[6])),
  CylindersClean = c(matrix(summary(CaseData.NewCars.Filtered.ImputedHPAndCylinders[20])),"-"),
  Doors =	matrix(summary(CaseData.NewCars[9])),
  DoorsClean = c(matrix(summary(CaseData.NewCars.Filtered.ImputedHPAndCylinders[21])),"-")
)%>%
 kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover"), font_size = 12)%>%
    add_header_above(c("Summary Data Continued" = 6))
ktable

# data.frame(summary(CaseData.NewCars))
# data.frame(matrix(summary(CaseData.NewCars)))

```

